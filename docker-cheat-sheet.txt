# Git clone
git clone --recurse-submodules /Users/william/Developer/infra-poc/vm/Heater-Controller-Env-Virtual-Machine

# Override docker-compose
https://medium.com/softonic-eng/docker-compose-from-development-to-production-88000124a57c

# Docker stack deploy
docker stack deploy -c docker-compose.yml stacktest

# Docker
docker system prune -a
docker volume prune
docker volume ls
docker logs [container name] (https://medium.com/@pimterry/5-ways-to-debug-an-exploding-docker-container-4f729e2c0aa8)

# Helpers
docker-compose logs -f

docker stop $(docker ps -a -q)
docker rm $(docker ps -a -q)


# Volumes
screen ~/Library/Containers/com.docker.docker/Data/vms/0/tty
  # Example: /var/lib/docker/volumes/heater-controller-server-services_mosquitto_data/_data
  # Exit: ctrl a + ctrl d -> Then `screen -ls`


# Development

docker-compose up -d --build
docker-compose exec web python manage.py migrate --noinput
docker build services/heater_control_app --file services/heater_control_app/Dockerfile --tag heater_control:dev_stable


# Production

docker-compose -f docker-compose.prod.yml up -d --build
docker-compose -f docker-compose.prod.yml up -d
docker-compose -f docker-compose.prod.yml down -v
docker build services/heater_control_app --file services/heater_control_app/Dockerfile.prod --tag heater_control:master_stable

# TODO: This has to be removed in the future: The CI/CD script should be responsible for executing it by using `docker-compose -f docker-compose.prod.yml exec web python manage.py migrate --noinput`
docker-compose -f docker-compose.prod.yml exec web python manage.py migrate --noinput
docker-compose -f docker-compose.prod.yml exec web python manage.py collectstatic --no-input --clear


# MQTT Broker
docker-compose exec mqttbroker kill -SIGHUP 1
  -> This command will have the mosquitto mqtt broker to reload the configuration file
